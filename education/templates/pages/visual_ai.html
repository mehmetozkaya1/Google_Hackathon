{% extends 'layout.html' %}
{% load static %}

{% block title %}
    Visual AI
{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
    <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <div class="card-new">
                <h4 class="card-title text-center mb-4 mt-3">Hemen Çözümünü Öğren!</h4>
                <p class="card-text mt-2">
                    Bir fotoğrafın metnini çıkarmak, çözdüğünüz sorunun doğrulununu kontrol etmek ya da o soruyu yapay zekaya çözdürmek mi istiyorsunuz? Hemen bir fotoğraf yükleyin ve yapay zekanın yeteneklerini izleyin.
                </p>
                {% if success %}
                    <div class="alert alert-success mt-3">Resim dosyanız başarıyla yüklendi!</div>
            
                    {% if file_url %}
                        <div class="mt-3 mb-3">
                            <img src="{% static file_url %}" alt="Yüklenen Resim" class="img-fluid" style="max-width: 500px; height: auto;">
                        </div>
                    {% endif %}

                    <div class="text-center">
                        <form id="ask-form" class="text-center mt-1">
                            {% csrf_token %}
                            <p>Bu resim dosyası ile ilgili neyi öğrenmek istersiniz?</p>
                            <div class="input-group">
                                <span class="input-group-text ml-2">İstekler</span>
                                <textarea class="form-control mr-2" name="expectations" id="expectations" aria-label="With textarea" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-color mt-3 mb-3">Sor</button>
                        </form>
                        <div id="spinner" class="spinner-border text-primary mt-3" role="status" style="display: none; margin: auto;">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <!-- Yanıtın Görüntüleneceği Alan -->
                        <div id="response-container" class="mt-4"></div>
                    </div>
                {% else %}
                    <form method="post" enctype="multipart/form-data" action="{% url 'upload_image' %}">
                        {% csrf_token %}
                        <div class="form-group text-center">
                            <label for="imgUpload" class="btn btn-color">
                                <i class="fas fa-file-upload fa-2x p-2"></i>
                                <span class="ml-2">Resim Dosyası Seçin</span>
                            </label>
                            <input type="file" id="imgUpload" name="img_file" accept="image/*" class="form-control-file" style="display: none;" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-color mt-3 mb-3">
                                <i class="fa-regular fa-circle-down"></i>
                                <span class="ml-2">Yükle</span>
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
        <div class="col-md-2"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#ask-form').on('submit', function(e) {
            e.preventDefault();

            $('#spinner').show();

            let expectations = $('#expectations').val();
            let csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

            $.ajax({
                url: "{% url 'ask' %}",
                type: "POST",
                data: {
                    'expectations': expectations,
                    'csrfmiddlewaretoken': csrfToken
                },
                success: function(response) {
                    $('#spinner').hide();
                    let formattedResponse = response.response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    $('#response-container').html(`<p>${formattedResponse}</p>`);
                },
                error: function() {
                    $('#spinner').hide();
                    $('#response-container').html('<p>Bir hata oluştu. Lütfen tekrar deneyin.</p>');
                }
            });
        });
    });
</script>
{% endblock %}
